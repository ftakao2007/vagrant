LVS,keepalived
==========
## LVS (Linux Virtual Server)
Linuxサーバーをロードバランサとして使用するためのソフトウェア。  
ロードバランサを使ってリクエストを振り分けることで負荷の分散を図る。  
Linuxカーネルに組み込んで使用するカーネルモジュールと設定や管理を行うためのipvsadmコマンドから構成。

### LVSを使ったロードバランサを実現するためのネットワーク構成
* レイヤ4スイッチング
  * TCP/IPレベルでパケットを転送する方式
  * サーバーの代わりにクライアントからリクエストを受け取り、そのリクエストを一定のルールでサーバーに転送する処理を実現

* パケット転送方式
  * NAT
    * IPパケットに対しロードバランサでNATを行ってパケットをサーバーに転送する
    * ローカルネットワークとWANの接続部分に設置する
    * サーバーがローカルネットワーク内にある場合など、サーバーとクライアントが直接接続できない場合でも利用できる
    * 最も一般的
      * サーバーをインターネットから直接アクセスできないローカルネットワーク内に設置し、ロードバランサーに対してのみインターネットからのアクセスが可能な構成にできる
      * サーバーを狙った攻撃をブロックすることができる
  * ダイレクトルーティング
    * IPパケットを書き換えずにパケットをサーバーに転送する
    * サーバーからクライアントへの通信についてはロードバランサを経由しない
  * トンネリング
    * IPパケットをカプセル化した上でサーバーに転送する
    * サーバーからクライアントへの通信についてはロードバランサを経由しない
    * ロードバランサとサーバー間の通信にカプセル化されたIPパケットが利用される
        * ロードバランサとサーバーが別のネットワーク上にあっても利用できる

## keepalived
サービスの稼働状態を監視するソフトウェア。  
サービスが停止していたらそのサーバーへのリクエストの振り分けをやめるようLVSの設定を変更する、という機能を持っている。  
(LVSにはロードバランス対象を監視する仕組みが用意されていない)  


## 事前設定
---
    [ipv6 off]
    sudo vi /etc/sysctl.conf
    ===
    net.ipv6.conf.all.disable_ipv6 = 1
    net.ipv6.conf.default.disable_ipv6 = 1
    ===
    sudo sysctl -p

## LVSインストール
パケット転送方式はNAT

---
    [ロードバランサーの設定]
    sudo yum install ipvsadm
    # 仮想サービス用IP設定
    cd /etc/sysconfig/network-scripts
    sudo vi ifcfg-eth2:0
    ===
    TYPE=Ethernet
    ONBOOT=yes
    IPADDR=172.20.10.4      # VMを起動した時にDHCPで割り当てられたIPを元に設定
    NETMASK=255.255.255.240 # VMを起動した時にDHCPで割り当てられたIPを元に設定
    DEVICE=eth2:0
    ===
    sudo ifup eth2:0
    # ポートフォワード設定
    sudo vi /etc/sysctl.conf
    ===
    net.ipv4.ip_forward = 1
    ===
    sudo /sbin/sysctl -p
    # LVS設定
    sudo ipvsadm -C  # LVS設定クリア
    sudo ipvsadm -A -t 172.20.10.4:80  # 仮想サービスのIP設定。VMを立ち上げた時にアサインされたIPを追記
    sudo ipvsadm -a -t 172.20.10.4:80 -r 192.168.33.92:80 -m  # 転送先の登録
    sudo ipvsadm -a -t 172.20.10.4:80 -r 192.168.33.93:80 -m
    sudo ipvsadm -l
    sudo ipvsadm save  # 再起動後もLVSの設定を残す場合
    sudo chkconfig ipvsadm on  # 再起動後も自動でLVSを起動する場合

---
    [サーバ側設定]
    # デフォルトgw設定
    netstat -rn  # 現在の設定確認
    sudo route add default gw 192.168.33.91
    netstat -rn  # デフォルトgwがロードバランサーになっていることを確認する

この状態でブラウザで`http:/172.20.10.4` にアクセスするとnode2, node3にアクセス可能となる。デフォルトではブラウザを更新するごとにnode2, node3が交互に表示される。
